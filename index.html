<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Firebase compat CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <!-- Your Firebase config must define: const firebaseConfig = {...} -->
  <script src="config.js"></script>
  <style>
    /* Minimal, clean, mobile-first */
    :root {
      --bg: #101012;
      --panel: #1a1b1e;
      --muted: #c8c8cc;
      --accent: #27c93f;
      --border: #2a2b30;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg); color: #fff; }
    .auth {
      max-width: 420px; margin: 40px auto; padding: 16px; background: var(--panel); border: 1px solid var(--border); border-radius: 8px;
    }
    .auth h1 { margin: 0 0 12px; font-size: 20px; }
    .row { display: grid; gap: 8px; }
    input {
      width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px;
      background: #121316; color: #fff; font-size: 15px;
    }
    .btn {
      width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--accent);
      color: #0a0a0a; font-weight: 600; cursor: pointer;
    }
    .btn.secondary { background: #25262b; color: var(--muted); }
    .hint { color: var(--muted); font-size: 13px; margin-top: 6px; }

    /* Chat layout */
    #chat { display: none; height: 100vh; }
    .chat-wrap {
      display: grid; grid-template-columns: 220px 1fr; grid-template-rows: 1fr auto; height: 100%;
    }
    .users {
      grid-row: 1 / span 2; border-right: 1px solid var(--border); background: var(--panel); padding: 10px; overflow-y: auto;
    }
    .users h2 { font-size: 14px; margin: 0 0 8px; color: var(--muted); }
    .users .item { padding: 6px 8px; border-radius: 6px; background: #131417; margin-bottom: 6px; font-size: 14px; }

    .messages {
      background: #0f1013; padding: 10px; overflow-y: auto; border-bottom: 1px solid var(--border);
    }
    .msg { padding: 8px; background: #16171b; border: 1px solid var(--border); border-radius: 8px; margin: 6px 0; font-size: 14px; }
    .msg .u { color: var(--muted); margin-right: 6px; }

    .send {
      display: grid; grid-template-columns: 1fr 120px; gap: 8px; padding: 10px; background: var(--panel);
      border-top: 1px solid var(--border);
    }
    #msgInput { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: #121316; color: #fff; }
    .send .btn { width: 100%; }

    /* Admin panel (inline, minimal) */
    #adminPanel {
      display: none; max-width: 420px; margin: 16px auto 0; padding: 12px; background: var(--panel);
      border: 1px solid var(--border); border-radius: 8px;
    }
    #adminPanel .grid { display: grid; grid-template-columns: 1fr auto; gap: 8px; }
    @media (max-width: 760px) {
      .chat-wrap { grid-template-columns: 1fr; }
      .users { display: none; }
    }
  </style>
</head>
<body>

<!-- Auth (single form: login + direct register) -->
<div class="auth" id="auth">
  <h1>Hareketli Blok Chat</h1>
  <div class="row">
    <input id="username" placeholder="Kullanıcı adı">
    <input id="password" type="password" placeholder="Şifre">
    <button class="btn" onclick="login()">Giriş Yap</button>
    <button class="btn secondary" onclick="register()">Kayıt Ol (direkt)</button>
    <div class="hint">Admin kullanıcı adı: admin</div>
  </div>
</div>

<!-- Admin panel (shows only for 'admin') -->
<div id="adminPanel">
  <div class="row">
    <button class="btn" onclick="clearMessages()">Tüm mesajları sil</button>
    <div class="grid">
      <input id="banUser" placeholder="Banlanacak kullanıcı adı">
      <button class="btn secondary" onclick="ban()">Banla</button>
    </div>
    <button class="btn secondary" onclick="goChat()">Chat'e geç</button>
  </div>
</div>

<!-- Chat -->
<div id="chat">
  <div class="chat-wrap">
    <div class="users" id="users">
      <h2>Çevrimiçi</h2>
      <!-- Filled dynamically -->
    </div>
    <div class="messages" id="messages"></div>
    <div class="send">
      <input id="msgInput" placeholder="Mesaj yaz...">
      <button class="btn" onclick="sendMessage()">Gönder</button>
    </div>
  </div>
</div>

<script>
  // Init Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let currentUser = null;
  let bannedUsers = [];

  // Single-form register: direct writes to users collection
  async function register() {
    const name = document.getElementById("username").value.trim();
    const pass = document.getElementById("password").value;
    if (!name || !pass) { alert("İsim ve şifre zorunlu."); return; }
    try {
      await db.collection("users").doc(name).set({ username: name, password: pass }, { merge: true });
      alert("Kayıt başarılı. Şimdi giriş yapabilirsin.");
    } catch (e) {
      alert("Kayıt hatası: " + e.message);
    }
  }

  // Login by checking users collection
  async function login() {
    const name = document.getElementById("username").value.trim();
    const pass = document.getElementById("password").value;
    if (!name || !pass) { alert("İsim ve şifre zorunlu."); return; }

    try {
      const doc = await db.collection("users").doc(name).get();
      if (doc.exists && doc.data().password === pass) {
        currentUser = name;
        document.getElementById("auth").style.display = "none";
        if (name === "admin") {
          document.getElementById("adminPanel").style.display = "block";
        } else {
          startChat();
        }
      } else {
        alert("Hatalı giriş.");
      }
    } catch (e) {
      alert("Giriş hatası: " + e.message);
    }
  }

  function startChat() {
    document.getElementById("adminPanel").style.display = "none";
    document.getElementById("chat").style.display = "block";
    ensureUserListed(currentUser);
    listenMessages();
    listenOnlineUsers();
    setOnline(true);
    window.addEventListener("beforeunload", () => setOnline(false));
  }

  // Messages
  async function sendMessage() {
    if (!currentUser) return;
    if (bannedUsers.includes(currentUser)) { alert("Banlandın."); return; }
    const text = document.getElementById("msgInput").value.trim();
    if (!text) return;
    try {
      await db.collection("messages").add({ user: currentUser, text, time: Date.now() });
      document.getElementById("msgInput").value = "";
    } catch (e) {
      alert("Mesaj hatası: " + e.message);
    }
  }

  function listenMessages() {
    db.collection("messages").orderBy("time").onSnapshot(snap => {
      const box = document.getElementById("messages");
      box.innerHTML = "";
      snap.forEach(doc => {
        const d = doc.data();
        const el = document.createElement("div");
        el.className = "msg";
        el.innerHTML = `<span class="u">${d.user}</span>${d.text}`;
        box.appendChild(el);
      });
      box.scrollTop = box.scrollHeight;
    });
  }

  // Admin tools
  async function clearMessages() {
    try {
      const snap = await db.collection("messages").get();
      const batch = db.batch();
      snap.forEach(d => batch.delete(db.collection("messages").doc(d.id)));
      await batch.commit();
      alert("Mesajlar temizlendi.");
    } catch (e) {
      alert("Temizleme hatası: " + e.message);
    }
  }

  function ban() {
    const u = document.getElementById("banUser").value.trim();
    if (!u) return;
    if (!bannedUsers.includes(u)) bannedUsers.push(u);
    alert(u + " banlandı.");
  }

  function goChat() {
    startChat();
    ensureUserListed("admin");
  }

  // Online users (simple presence flag in users collection)
  async function setOnline(isOnline) {
    if (!currentUser) return;
    try {
      await db.collection("users").doc(currentUser).set({ online: isOnline, lastSeen: Date.now() }, { merge: true });
    } catch {}
  }

  function listenOnlineUsers() {
    db.collection("users").where("online", "==", true).onSnapshot(snap => {
      const list = document.getElementById("users");
      list.innerHTML = "<h2>Çevrimiçi</h2>";
      snap.forEach(doc => {
        const u = doc.data().username || doc.id;
        const div = document.createElement("div");
        div.className = "item";
        div.textContent = u;
        list.appendChild(div);
      });
    });
  }

  function ensureUserListed(name) {
    // No-op with presence; kept for compatibility
  }
</script>
</body>
</html>